---
kind: pipeline
name: Backend Test

platform:
  os: linux
  arch: amd64

steps:
- name: build
  image: composer:latest
  commands:
  - composer install --no-interaction --ignore-platform-reqs --no-plugins --no-scripts

- name: Grab some important files
  image: mesosphere/aws-cli
  environment:
     AWS_ACCESS_KEY_ID:
       from_secret: aws_access_key_id
     AWS_SECRET_ACCESS_KEY:
       from_secret: aws_secret_access_key
     AWS_DEFAULT_REGION: us-west-2
  commands:
    - aws s3 cp s3://matabit/dev/dev.env .env
    
- name: PHPUnit Test
  image: php:7.3-rc-cli-alpine
  commands:
  - php artisan key:generate
  - vendor/bin/phpunit #--configuration phpunit.xml
  
---
kind: pipeline
name: Frontend Test

platform:
  os: linux
  arch: amd64

steps:
- name: Build
  image: node:carbon-alpine
  commands:
    - npm -i

- name: Test
  image: node:carbon-alpine
  commands:
    - npm test
# - name: Slack
#   image: plugins/slack
#   when:
#   status: [ success, failure ]
#   settings:
#     webhook:
#       from_secret: slack_webhook
#     channel: classrooms-drone
#     template: >
#       {{#success build.status}}
#         Build {{build.number}} succeeded. Good job.
#       {{else}}
#         Build {{build.number}} failed. Fix me please.
#       {{/success}}

# trigger:
#   event:
#   - pull_request
# ---
# kind: pipeline
# name: deploy dev
# steps:

# - name: Grab some important files
#   image: mesosphere/aws-cli
#   environment:
#      AWS_ACCESS_KEY_ID:
#        from_secret: aws_access_key_id
#      AWS_SECRET_ACCESS_KEY:
#        from_secret: aws_secret_access_key
#      AWS_DEFAULT_REGION: us-west-2
#   commands:
#     - aws s3 cp s3://matabit/dev/dev.env .env
#     - aws s3 cp s3://matabit/dev/apache.conf .

# trigger:
#   branch:
#   - dev
#   event:
#   - push
# ---
# kind: pipeline
# name: deploy prod
# steps:

# - name: Grab some important files
#   image: mesosphere/aws-cli
#   environment:
#      AWS_ACCESS_KEY_ID:
#        from_secret: aws_access_key_id
#      AWS_SECRET_ACCESS_KEY:
#        from_secret: aws_secret_access_key
#      AWS_DEFAULT_REGION: us-west-2
#   commands:
#     - aws s3 cp s3://matabit/prod/prod.env .env
#     - aws s3 cp s3://matabit/prod/apache.conf .

# trigger:
#   branch:
#   - master
#   event:
#   - push
...
